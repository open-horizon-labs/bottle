# Release Workflow Improvement Plan

## Current State

The current `release.yml` is auto-generated by cargo-dist with manual patches:
- Version bumping via `perl -i -pe` in each job (duplicated 4x)
- `allow-dirty = ["ci"]` to suppress cargo-dist's validation
- Manually added `publish-crates` job
- Fragile: cargo-dist may overwrite customizations on `dist init`

## Proposed Approach

Adopt the **centralized plan pattern** from unified-hifi-control:

### 1. Centralized Plan Job

Single source of truth for:
- **Version computation**: Extract from tag, no need to patch Cargo.toml
- **Build decisions**: Is this a release? PR? Manual dispatch?
- **Outputs**: Version, git SHA, flags for optional jobs

```yaml
plan:
  outputs:
    version: "0.3.0"       # From v0.3.0 tag
    git_sha: "abc1234"
    is_release: true
    publish_homebrew: true
    publish_crates: true
```

### 2. Version Injection Strategy

Instead of patching Cargo.toml at build time:
- Use `cargo install` with `--version` flag for release builds
- Or: Set version via environment variable at compile time (requires code change)
- Or: Keep perl patch but only in plan job, share artifact

**Recommended**: Keep the perl patch approach (simplest), but consolidate it.

### 3. Workflow Structure

```
```
PR workflow:
┌──────┐   ┌────────┐   ┌──────┐
│ lint │   │ clippy │   │ test │   (parallel)
└──────┘   └────────┘   └──────┘

Release workflow (on tag push):
┌─────────┐
│  plan   │  Compute version from tag (~5s)
└────┬────┘
     │
     ├───────────────────────┐
     │                       │
┌────▼─────┐          ┌──────▼──────┐
│  build   │          │    build    │
│ arm64    │          │    x64      │  (parallel macOS builds)
└────┬─────┘          └──────┬──────┘
     │                       │
     └───────────┬───────────┘
                 │
          ┌──────▼──────┐
          │   release   │  Create GitHub release, upload binaries
          └──────┬──────┘
                 │
      ┌──────────┼──────────┐
      │          │          │
┌─────▼────┐ ┌───▼───┐ ┌────▼─────┐
│ homebrew │ │crates │ │ announce │
│   tap    │ │  io   │ │          │
└──────────┘ └───────┘ └──────────┘
```
```

### 4. Key Changes

| Current | Proposed |
|---------|----------|
| cargo-dist generated | Custom workflow (own the file) |
| macOS targets (arm64 + x64) | Same targets, cleaner workflow |
| Version patch in 4 jobs | Version computed once in plan |
| Implicit cargo-dist logic | Explicit, readable conditions |
| No PR testing | Add lint + clippy + test for PRs |
| No concurrency control | Cancel in-progress on new push |
| Basic caching | rust-cache + registry cache per target |

### 5. Caching Strategy

```yaml
# Rust dependencies (swatinem/rust-cache)
- uses: swatinem/rust-cache@v2
  with:
    cache-on-failure: true
    key: ${{ matrix.target }}  # Separate cache per target

# Cargo registry (speeds up cargo publish)
- uses: actions/cache@v4
  with:
    path: ~/.cargo/registry
    key: cargo-registry-${{ hashFiles('Cargo.lock') }}
```

**Cache benefits:**
- ~60-80% faster builds after first run
- Separate caches per target (arm64 vs x64)
- Registry cache speeds up crates.io publish

### 6. Triggers

```yaml
on:
  pull_request:           # Lint + test only
  push:
    tags: ['v*']          # Full release
  workflow_dispatch:      # Manual with options
    inputs:
      publish_crates:
        type: boolean
        default: true
```

### 6. Migration Path

1. Create new `release.yml` alongside cargo-dist's
2. Test with manual dispatch
3. Remove cargo-dist workflow
4. Update `dist-workspace.toml` to disable CI generation

## Files to Create/Modify

- `.github/workflows/release.yml` - New custom workflow
- `dist-workspace.toml` - Add `ci = false` to disable cargo-dist CI
- `Cargo.toml` - No changes needed

## Decisions Made

- **Targets**: macOS only (aarch64-apple-darwin + x86_64-apple-darwin) - current targets, no Windows
- **Artifact generation**: Keep cargo-dist for cross-compilation, but own the workflow
- **PR testing**: Yes, lint + clippy + test

## Implementation Summary

1. macOS universal binary (arm64 + x64)
2. Publish to: GitHub Release, Homebrew tap, crates.io
3. PR workflow: lint, clippy, test
4. Release workflow: plan → build → release → publish
